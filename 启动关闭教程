# ROS2 Docker 启动和关闭教程

## 1. 启动 ROS2 环境

### 1.1 启动 Docker 容器
```bash
# 启动所有服务
docker-compose up -d

# 重新构建并启动（如果修改了 Dockerfile）
docker-compose build --no-cache
docker-compose up -d
```

### 1.2 验证服务状态
```bash
# 查看容器状态
docker-compose ps

# 查看 ROS2 主节点日志
docker logs ros2_master

# 查看 RViz 日志
docker logs ros2_rviz
```

### 1.3 测试 ROS2 节点
```bash
# 进入主节点容器
docker exec -it ros2_master bash

# 在容器内运行发布者节点
source /opt/ros/humble/setup.bash
ros2 run demo_nodes_py talker

# 在另一个终端运行订阅者节点
source /opt/ros/humble/setup.bash
ros2 run demo_nodes_py listener
```

## 2. 关闭 ROS2 环境

### 2.1 停止运行中的节点
```bash
# 如果有正在运行的 ROS2 节点，先停止它们
# 按 Ctrl+C 终止当前运行的节点
# 或者在后台运行时使用：
pkill -f "ros2 run"
```

### 2.2 停止 Docker 容器
```bash
# 正常停止所有容器
docker-compose down

# 强制停止（如果正常停止无效）
docker-compose down -t 1

# 只停止特定容器
docker-compose stop ros2_master
docker-compose stop ros2_rviz
```

### 2.3 清理 Docker 资源
```bash
# 删除所有停止的容器
docker container prune

# 删除未使用的镜像
docker image prune

# 完全清理（包括卷和网络）
docker-compose down -v --remove-orphans
```

## 3. 常用管理命令

### 3.1 查看状态
```bash
# 查看所有 Docker 容器
docker ps -a

# 查看 ROS2 包列表
docker exec ros2_master bash -c "source /opt/ros/humble/setup.bash && ros2 pkg list"

# 查看活跃的 ROS2 节点
docker exec ros2_master bash -c "source /opt/ros/humble/setup.bash && ros2 node list"
```

### 3.2 重新启动
```bash
# 重启特定容器
docker-compose restart ros2_master

# 重启所有容器
docker-compose restart

# 完全重新构建并启动
docker-compose down
docker-compose build --no-cache
docker-compose up -d
```

## 4. 故障排除

### 4.1 端口冲突
```bash
# 检查端口占用
netstat -an | grep 11311
netstat -an | grep 8080

# 如果端口被占用，可以停止相关服务或修改 docker-compose.yml 中的端口映射
```

### 4.2 容器无法启动
```bash
# 查看详细错误信息
docker-compose logs ros2_master
docker-compose logs ros2_rviz

# 检查 Docker 服务状态
docker info
```

### 4.3 ROS2 节点通信问题
```bash
# 检查网络连接
docker exec ros2_master ping ros2_rviz

# 检查 ROS2 环境变量设置
docker exec ros2_master bash -c "env | grep ROS"

# 检查话题列表
docker exec ros2_master bash -c "source /opt/ros/humble/setup.bash && ros2 topic list"
```

## 5. 快速操作参考

| 操作 | 命令 |
|------|------|
| 启动所有服务 | `docker-compose up -d` |
| 停止所有服务 | `docker-compose down` |
| 查看服务状态 | `docker-compose ps` |
| 查看 Master 日志 | `docker logs ros2_master` |
| 查看 RViz 日志 | `docker logs ros2_rviz` |
| 进入 Master 容器 | `docker exec -it ros2_master bash` |
| 重新构建启动 | `docker-compose build --no-cache && docker-compose up -d` |

## 6. 安全注意事项

- 始终使用 `docker-compose down` 而不是 `docker kill` 来优雅地停止容器
- 在停止容器之前，确保所有的 ROS2 节点都已正常退出
- 定期清理未使用的 Docker 资源以节省磁盘空间
- 备份重要的配置文件和数据卷进行清理操作
